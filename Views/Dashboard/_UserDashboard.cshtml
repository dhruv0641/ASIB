@model ASIB.Models.ViewModels.UserDashboardViewModel
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dashboard</title>
        <script src="https://kit.fontawesome.com/e3a2608462.js" crossorigin="anonymous"></script>
        <style>
            :root {
                --bg-color: #f3f2ef;
                --white-color: #ffffff;
                --text-color: rgba(0, 0, 0, 0.9);
                --text-muted: rgba(0, 0, 0, 0.6);
                --brand-color: #0a66c2;
                --border-color: #e0e0e0;
                --card-radius: 8px;
                --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                background-color: var(--bg-color);
                margin: 0;
                padding-top: 52px;
                color: var(--text-color);
            }
            a {
                text-decoration: none;
                color: inherit;
            }

            /* --- Main Navigation Bar --- */
            .navbar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 52px;
                background-color: var(--white-color);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0 24px;
                z-index: 1000;
            }
            .nav-container {
                width: 100%;
                max-width: 1128px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .nav-left {
                display: flex;
                align-items: center;
                gap: 8px;
                position: relative; /* Added */
            }
            .nav-logo-img {
                height: 52px;
                width: auto;
                vertical-align: middle;
            }
            .search-box {
                background-color: #eef3f8;
                border-radius: 4px;
                padding: 0 12px;
                display: flex;
                align-items: center;
                width: 280px;
                height: 34px;
            }
            .search-box i {
                color: var(--text-muted);
            }
            .search-box input {
                border: none;
                background: transparent;
                outline: none;
                margin-left: 8px;
                width: 100%;
                font-size: 14px;
            }
            .nav-right {
                display: flex;
                align-items: center;
                gap: 20px;
            }
            .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                color: var(--text-muted);
                font-size: 12px;
                cursor: pointer;
                transition: color 0.2s;
                position: relative; /* Added */
            }
            .nav-item:hover, .nav-item.active {
                color: var(--text-color);
            }
            .nav-item i {
                font-size: 20px;
                margin-bottom: 2px;
            }
            .nav-profile img {
                width: 24px;
                height: 24px;
                border-radius: 50%;
                object-fit: cover;
            }
            .nav-profile {
                position: relative;
            }
            .nav-profile span {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            .dropdown-menu {
                position: absolute;
                top: 52px;
                right: 0;
                width: 240px;
                background-color: var(--white-color);
                border: 1px solid var(--border-color);
                border-radius: var(--card-radius);
                box-shadow: var(--shadow);
                z-index: 1100;
            }
            .dropdown-header {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                border-bottom: 1px solid var(--border-color);
            }
            .dropdown-header img {
                width: 48px;
                height: 48px;
                border-radius: 50%;
            }
            .dropdown-header strong {
                font-size: 16px;
            }
            .dropdown-header p {
                font-size: 12px;
                color: var(--text-muted);
                margin: 0;
            }
            .dropdown-menu .dropdown-link {
                display: block;
                padding: 12px 16px;
                font-size: 14px;
                color: var(--text-color);
                transition: background-color 0.2s;
            }
            .dropdown-menu .dropdown-link:hover {
                background-color: var(--bg-color);
            }

            /* --- Main Layout --- */
            .main-container {
                max-width: 1128px;
                margin: 24px auto;
                display: grid;
                grid-template-columns: 225px 1fr 300px;
                gap: 24px;
            }
            .card {
                background-color: var(--white-color);
                border: 1px solid var(--border-color);
                border-radius: var(--card-radius);
                box-shadow: var(--shadow);
                overflow: hidden;
            }

            /* --- Sidebars & Role Section --- */
            .profile-card {
                text-align: center;
            }
            .profile-card-header {
                height: 56px;
                background-color: #a0b4b7;
            }
            .profile-card-photo {
                width: 72px;
                height: 72px;
                border-radius: 50%;
                border: 2px solid var(--white-color);
                margin: -36px auto 12px;
                display: block;
                object-fit: cover;
            }
            .profile-card h3 {
                font-size: 16px;
                margin: 0;
                padding: 0 16px;
            }
            .profile-card p {
                font-size: 12px;
                color: var(--text-muted);
                margin: 4px 0 16px;
                padding: 0 16px;
            }

            .post-author-photo {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }
            .post-container a[href*="Dashboard/UserProfile"]:hover strong {
                text-decoration: underline;
                color: var(--brand-color);
            }

            .profile-card a {
                display: block;
                padding: 12px;
                font-size: 14px;
                font-weight: 600;
                color: var(--brand-color);
                border-top: 1px solid var(--border-color);
                transition: background-color 0.2s;
            }
            .profile-card a:hover {
                background-color: #f3f2ef;
            }
            .role-section {
                padding: 20px;
                margin-bottom: 24px;
            }

            /* --- "Start a Post" & Post Feed --- */
            .post-box {
                padding: 12px;
                margin-bottom: 24px;
            }
            .start-post-trigger {
                display: flex;
                align-items: center;
                gap: 12px;
                cursor: pointer;
            }
            .start-post-trigger img {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                object-fit: cover;
            }
            .start-post-trigger input {
                flex: 1;
                border: 1px solid var(--border-color);
                border-radius: 35px;
                padding: 12px 16px;
                font-size: 14px;
                background-color: transparent;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .start-post-trigger input:hover {
                background-color: #f3f2ef;
            }
            .post-box-actions {
                display: flex;
                justify-content: space-around;
                padding-top: 8px;
                margin-top: 8px;
            }
            .post-box-actions .action-btn {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                flex-grow: 0;
                padding: 8px 12px;
            }
            .post-box-actions .action-btn svg {
                width: 24px;
                height: 24px;
            }
            .action-btn {
                background: none;
                border: none;
                cursor: pointer;
                color: #666;
                font-weight: bold;
                padding: 10px;
                flex-grow: 1;
                border-radius: 4px;
            }
            .action-btn:hover {
                background-color: #f3f2ef;
            }

            /* --- Follow Button Styles --- */
            .follow-btn {
                flex-shrink: 0;
                margin-left: auto;
                padding: 6px 12px;
                border-radius: 15px;
                background: transparent;
                border: 1px solid var(--brand-color);
                color: var(--brand-color);
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .follow-btn.following, .follow-btn:hover {
                background-color: rgba(10, 102, 194, 0.1);
            }

            /* --- Modal Styles --- */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.6);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .modal-content {
                background-color: var(--white-color);
                border-radius: var(--card-radius);
                width: 100%;
                max-width: 550px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                display: flex;
                flex-direction: column;
            }
            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px;
                border-bottom: 1px solid var(--border-color);
            }
            .modal-header h3 {
                margin: 0;
                font-size: 20px;
                font-weight: 600;
            }
            .close-modal-btn {
                background: none;
                border: none;
                font-size: 28px;
                cursor: pointer;
                color: var(--text-muted);
            }
            .modal-body {
                padding: 16px;
            }
            .modal-user-info {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 12px;
            }
            .modal-user-info img {
                width: 48px;
                height: 48px;
                border-radius: 50%;
            }
            .modal-user-info strong {
                font-size: 16px;
            }
            .modal-body textarea {
                width: 100%;
                border: none;
                outline: none;
                min-height: 120px;
                font-size: 16px;
                resize: vertical;
                box-sizing: border-box;
                font-family: inherit;
            }
            #media-preview-container {
                margin-top: 16px;
            }
            #media-preview-container img, #media-preview-container video {
                max-width: 100%;
                max-height: 300px;
                border-radius: var(--card-radius);
            }
            .modal-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px;
                border-top: 1px solid var(--border-color);
            }
            .modal-actions-left {
                display: flex;
                align-items: center;
                gap: 24px;
            }
            .modal-action-icon {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                color: var(--text-muted);
                cursor: pointer;
                font-weight: 600;
            }
            .modal-action-icon i {
                font-size: 22px;
            }
            .post-submit-btn {
                background-color: var(--brand-color);
                color: white;
                border: none;
                padding: 10px 24px;
                border-radius: 20px;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .post-submit-btn:disabled {
                background-color: #eef3f8;
                color: var(--text-muted);
                cursor: not-allowed;
            }

            /* --- Upcoming Events Sidebar --- */
            .upcoming-events-card {
                padding: 16px;
            }
            .upcoming-events-card h3 {
                margin-top: 0;
                margin-bottom: 12px;
                font-size: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid var(--border-color);
            }
            .event-item {
                list-style: none;
                margin-bottom: 16px;
            }
            .event-item a {
                text-decoration: none;
                color: inherit;
            }
            .event-item strong {
                display: block;
                font-size: 14px;
                color: var(--text-color);
                font-weight: 600;
                margin-bottom: 2px;
            }
            .event-item span {
                font-size: 12px;
                color: var(--text-muted);
            }
            .view-all-link {
                display: block;
                text-align: center;
                padding: 12px 0 4px;
                border-top: 1px solid var(--border-color);
                margin-top: 4px;
                font-weight: 600;
                color: var(--brand-color);
            }

            .hidden {
                display: none !important;
            }

            /* --- Search Results Styles --- */
            .search-results-container {
                position: absolute;
                top: 42px;
                left: 40px;
                width: 280px;
                background-color: var(--white-color);
                border: 1px solid var(--border-color);
                border-radius: var(--card-radius);
                box-shadow: var(--shadow);
                max-height: 400px;
                overflow-y: auto;
                z-index: 1050;
            }
            .search-result-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 8px 12px;
                transition: background-color 0.2s;
            }
            .search-result-item:hover {
                background-color: var(--bg-color);
            }
            .search-result-item img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }
            .search-result-item strong {
                font-size: 14px;
            }
            .search-result-item span {
                font-size: 12px;
                color: var(--text-muted);
            }

            /* --- Toast Notification Styles --- */
            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #28a745;
                color: white;
                padding: 16px;
                border-radius: var(--card-radius);
                box-shadow: var(--shadow);
                z-index: 9999;
                opacity: 0;
                visibility: hidden;
                transform: translateX(100%);
                transition: opacity 0.3s, visibility 0.3s, transform 0.3s ease-in-out;
            }
            .toast.show {
                opacity: 1;
                visibility: visible;
                transform: translateX(0);
            }
            .toast.error {
                background-color: #d9534f;
            }

            /* --- NEW: Mobile Search Box --- */
            .mobile-search-box {
                display: none; /* Hidden by default */
                position: relative; /* For the results dropdown */
                flex-grow: 1;
                margin: 0 16px;
                background-color: #eef3f8;
                border-radius: 4px;
                padding: 0 12px;
                align-items: center;
                height: 34px;
            }
            .mobile-search-box i {
                color: var(--text-muted);
            }
            .mobile-search-box input {
                border: none;
                background: transparent;
                outline: none;
                margin-left: 8px;
                width: 100%;
                font-size: 14px;
            }

            /* --- NEW: Style for mobile results dropdown --- */
            #mobile-search-results-container {
                top: 42px; /* Position below the search bar */
                left: 0;   /* Align to the left edge */
                right: 0;  /* Align to the right edge */
                width: auto; /* Override the fixed width from the desktop version */
            }

            /* --- Send Modal Styles --- */
            #send-post-modal .modal-content {
                max-width: 450px;
            }
            .send-modal-search-box {
                display: flex;
                align-items: center;
                padding: 16px 16px;
                border-bottom: 1px solid var(--border-color);
                position: sticky;
                top: 0;
                background-color: var(--white-color);
            }
            .send-modal-search-box i {
                color: var(--text-muted);
                font-size: 16px;
            }
            .send-modal-search-box input {
                width: 100%;
                border: none;
                outline: none;
                font-size: 16px;
                padding-left: 12px;
                font-family: inherit;
            }
            .send-modal-user-list {
                max-height: 350px;
                overflow-y: auto;
            }
            .send-modal-user-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .send-modal-user-item:hover {
                background-color: var(--bg-color);
            }
            .send-modal-user-item img {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                object-fit: cover;
            }
            .send-modal-user-item div {
                flex-grow: 1;
                min-width: 0;
            }
            .send-modal-user-item strong {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-color);
                display: block;
            }
            .send-modal-user-item span {
                font-size: 14px;
                color: var(--text-muted);
                display: block;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .send-modal-user-item input[type="checkbox"] {
                margin-left: 16px;
                transform: scale(1.3);
                cursor: pointer;
            }
            #send-post-form textarea {
                width: 100%;
                min-height: 80px;
                border: none;
                border-top: 1px solid var(--border-color);
                padding: 12px 16px;
                box-sizing: border-box;
                resize: vertical;
                outline: none;
                font-family: inherit;
                font-size: 14px;
            }

            /* --- NOTIFICATION STYLES (FIXED) --- */
            .nav-icon-wrapper {
                position: relative;
                line-height: 1; /* Aligns icon vertically */
            }
            .notification-badge {
                position: absolute;
                top: -3px;   /* Moves badge to the top of the icon */
                right: -14px;  /* Moves badge to the right of the icon */
                background-color: #d9534f;
                color: white;
                font-size: 11px;
                font-weight: 600;
                padding: 2px 6px;
                border-radius: 10px;
                line-height: 1;
            }
            .notification-item {
                display: flex;
                gap: 12px;
                padding: 12px;
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.2s;
            }
            .notification-item:last-child {
                border-bottom: none;
            }
            .notification-item:hover {
                background-color: var(--bg-color);
            }
            .notification-item img {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                flex-shrink: 0;
                object-fit: cover;
            }
            .notification-item p {
                margin: 0;
                font-size: 14px;
                line-height: 1.4;
                color: var(--text-color); /* <-- THE FIX for blue text */
            }
            .notification-item span {
                font-size: 12px;
                color: var(--text-muted);
            }
            .notification-item.unread {
                background-color: #eef3f8;
            }

            /* --- LINKEDIN STYLE ANNOUNCEMENT TITLE --- */
            /* Updated styles here */
            .announcement-title {
                display: block;
                color: var(--text-color); /* Dark text by default */
                font-weight: 600;         /* Bold text */
                font-size: 14px;
                cursor: pointer;
                text-decoration: none;    /* Remove underline */
                margin-bottom: 4px;
                line-height: 1.4;
                transition: color 0.2s;
            }
            .announcement-title:hover {
                color: var(--brand-color); /* Blue on hover */
                text-decoration: underline; /* Underline on hover */
            }
            /* ------------------------------------------ */

            .announcement-meta {
                font-size: 12px;
                color: var(--text-muted);
                margin-bottom: 12px;
            }

            /* --- NEW: Mobile Bottom Navigation --- */
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 56px;
                background-color: var(--white-color);
                display: none; /* Hidden by default */
                align-items: stretch; /* Stretch items to fill height */
                justify-content: space-around;
                border-top: 1px solid var(--border-color);
                z-index: 1001; /* Above content, below modals */
            }
            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                flex-grow: 1;
                padding: 6px 0;
                color: var(--text-muted);
                font-size: 10px;
                text-align: center;
                line-height: 1.4;
                cursor: pointer;
            }
            .mobile-nav-item i {
                font-size: 18px;
                margin-bottom: 2px;
            }
            .mobile-nav-item.active,
            .mobile-nav-item:hover {
                color: var(--text-color);
            }
            .mobile-nav-icon-wrapper {
                position: relative;
                display: flex; /* This helps center the icon */
                align-items: center;
                justify-content: center;
            }
            .mobile-notification-badge {
                position: absolute;
                top: -4px;  /* Position relative to icon */
                right: -8px; /* Position relative to icon */
                background-color: #d9534f;
                color: white;
                font-size: 10px;
                font-weight: 600;
                padding: 2px 5px;
                border-radius: 10px;
                line-height: 1;
            }

            /* --- Responsive --- */
            @@media (max-width: 992px) {
                .main-container {
                    grid-template-columns: 225px 1fr;
                }
                .right-sidebar {
                    display: none;
                }
            }

            /* --- REVISED 768px STYLES --- */
            @@media (max-width: 768px) {
                body {
                    padding-top: 52px; /* Ensure padding for top nav */
                    padding-bottom: 56px; /* Add padding for the new bottom nav */
                }
                .main-container {
                    grid-template-columns: 1fr;
                    padding: 0 16px;
                    margin-top: 16px; /* Reduced top margin */
                }
                .left-sidebar {
                    display: none;
                }
                .search-box {
                    display: none; /* Hide desktop search */
                }

                /* NEW: Show mobile search */
                .mobile-search-box {
                    display: flex;
                }

                .navbar {
                    padding: 0 16px; /* Reduce padding on mobile */
                }
                .nav-container {
                    justify-content: space-between;
                }

                /* Hide all text-based nav items in the top bar */
                .nav-right .nav-item {
                    display: none;
                }

                /* But *show* the Messages and "Me" (profile) items */
               
                .nav-right .nav-item.nav-profile {
                    display: flex;
                }

                /* And hide their text labels, so only icons show */
                .nav-right .nav-item[href*="Message"] span,
                .nav-right .nav-item.nav-profile span {
                    display: none;
                }
                .nav-right .nav-item[href*="Message"] i {
                    margin-bottom: 0;
                }
                .nav-right .nav-profile img {
                    margin-bottom: 0;
                }

                /* Show the new mobile bottom bar */
                .mobile-nav {
                    display: flex;
                }

                /* Adjust post box for mobile */
                .start-post-trigger img {
                    width: 40px;
                    height: 40px;
                }
                .start-post-trigger input {
                    padding: 10px 16px;
                }
                .post-box-actions {
                    margin-top: 0;
                }
                .post-box-actions .action-btn {
                    padding: 8px;
                    gap: 6px;
                }
                .post-box-actions .action-btn svg {
                    width: 20px;
                    height: 20px;
                }
            }
            /* Size the SVG icons in the Navbar */
.nav-item svg {
    width: 24px;
    height: 24px;
    margin-bottom: 2px;
    fill: currentColor; /* Uses the text color (grey/black) */
}

.nav-item.active svg {
    fill: #000000; /* Active icon color */
}

.search-box svg {
    width: 16px;
    height: 16px;
    fill: #666;
    margin-right: 8px;
}
            /* --- Mobile Bottom Navigation Styles --- */
.mobile-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 56px;
    background-color: #ffffff;
    border-top: 1px solid #e0e0e0;
    display: none; /* Hidden by default, shown in media query */
    align-items: stretch;
    justify-content: space-around;
    z-index: 1001;
    padding-bottom: env(safe-area-inset-bottom); /* Safe area for iPhone X+ */
}

.mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-grow: 1;
    padding: 6px 0;
    color: rgba(0, 0, 0, 0.6);
    font-size: 10px;
    text-decoration: none;
    cursor: pointer;
}

/* SVG Icon Styling */
.mobile-nav-item svg {
    width: 24px;
    height: 24px;
    margin-bottom: 4px;
    fill: currentColor; /* Inherits text color */
}

.mobile-nav-item.active {
    color: #000000; /* Active text color */
}

.mobile-nav-item.active svg {
    fill: #000000; /* Active icon color */
}

.mobile-nav-item:hover {
    background-color: #f3f2ef;
}

/* Notification Badge Wrapper */
.mobile-nav-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mobile-notification-badge {
    position: absolute;
    top: -2px;
    right: -6px;
    background-color: #d9534f;
    color: white;
    font-size: 10px;
    font-weight: 600;
    padding: 2px 5px;
    border-radius: 10px;
    line-height: 1;
}

/* Show on Mobile */
@@media (max-width: 768px) {
    .mobile-nav {
        display: flex;
    }
    body {
        padding-bottom: 56px; /* Push content up so navbar doesn't cover it */
    }
}
        </style>
    </head>
    <body>

        <div id="toast-notification" class="toast"></div>

        <nav class="navbar">
    <div class="nav-container">
        <div class="nav-left">
            <a asp-controller="Dashboard" asp-action="UserDashboard">
                <img src="image/logo.png" alt="College Logo" class="nav-logo-img">
            </a>
            <div class="search-box">
                <!-- Search Icon SVG -->
                <svg viewBox="0 0 24 24"><path d="M21.71 20.29l-5.01-5.01C17.54 13.93 18 12.35 18 10.5 18 6.36 14.64 3 10.5 3S3 6.36 3 10.5 6.36 18 10.5 18c1.85 0 3.43-.46 4.78-1.29l5.01 5.01c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41zM10.5 16C7.46 16 5 13.54 5 10.5S7.46 5 10.5 5 16 7.46 16 10.5 13.54 16 10.5 16z"/></svg>
                <input type="text" id="search-input" placeholder="Search by name or skill" autocomplete="off">
            </div>
            <div id="search-results-container" class="search-results-container hidden"></div>
        </div>
        <div class="nav-right">
            <!-- Home Icon -->
            <a asp-controller="Dashboard" asp-action="UserDashboard" class="nav-item @(Model.CurrentPage == "UserDashboard" ? "active" : "")"> 
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                <span>Home</span> 
            </a>

            <!-- Network Icon -->
            <a asp-controller="MyNetwork" asp-action="Index" class="nav-item @((Model.CurrentPage == "MyNetwork" || Model.CurrentPage == "Invitations" || Model.CurrentPage == "FollowNetwork") ? "active" : "")"> 
                <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                <span>My Network</span> 
            </a>

            <!-- Events Icon -->
            <a asp-controller="Event" asp-action="Index" asp-route-view="schedule" class="nav-item @(Model.CurrentPage == "Event" ? "active" : "")"> 
                <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>
                <span>Events</span> 
            </a>

            <!-- Messaging Icon -->
            <a asp-controller="Messages" asp-action="Index" class="nav-item @(Model.CurrentPage == "Message" ? "active" : "")"> 
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                <span>Messaging</span> 
            </a>

            <!-- Notification Icon -->
            <div class="nav-item @(Model.CurrentPage == "Notifications" ? "active" : "")" id="notification-trigger">
                <div class="nav-icon-wrapper"> 
                    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                    <span id="notification-badge" class="notification-badge hidden"></span>
                </div>
                <span>Notifications</span>
                
                <!-- Dropdown Code (Kept Same) -->
                <div id="notification-dropdown" class="dropdown-menu hidden" style="right: 0; width: 380px; top: 52px; max-height: 500px; overflow-y: auto;">
                    <div class="dropdown-header" style="justify-content: space-between; align-items: center;">
                        <strong style="font-size: 16px; padding: 0;">Notifications</strong>
                        <a asp-controller="Notifications" asp-action="Index" style="font-size: 13px; font-weight: 600; color: var(--brand-color); padding: 0; border: none;">View All</a>
                    </div>
                    <div id="notification-list">
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Profile Me Icon -->
            <div class="nav-item nav-profile" id="me-menu-trigger">
                <img src="@Model.ProfilePhoto" alt="Profile">
                <span>Me 
                    <!-- Caret Down Icon -->
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; margin-left: 4px;"><path d="M7 10l5 5 5-5z"/></svg>
                </span>
                <div class="dropdown-menu hidden" id="me-menu">
                    <div class="dropdown-header">
                        <img src="@Model.ProfilePhoto" alt="Profile">
                        <div>
                            <strong>@Model.UserName</strong>
                            <p>@Model.ProfileHeadline</p>
                        </div>
                    </div>
                    <a asp-controller="UserProfile" asp-action="Index" class="dropdown-link">View Profile</a>
                    <a asp-controller="Auth" asp-action="Logout" class="dropdown-link">Logout</a>
                </div>
            </div>
        </div>
    </div>
</nav>
        <main class="main-container">
            <aside class="left-sidebar">
                <div class="card profile-card">
                    <div class="profile-card-header"></div>
                    <img src="@Model.ProfilePhoto" alt="Profile Photo" class="profile-card-photo">
                    <h3>@Model.UserName</h3>
                    <p>@Model.ProfileHeadline</p>
                    <a asp-controller="UserProfile" asp-action="Index">View & Edit Profile</a>
                </div><br>
                <div class="card profile-card">
                    <a asp-controller="Dashboard" asp-action="UserDashboard">My Post</a>
                </div>
            </aside>

            <section class="main-content">
                <div class="card post-box">
                    <div id="start-post" class="start-post-trigger">
                        <img src="@Model.ProfilePhoto" alt="Profile">
                        <input type="text" placeholder="Start a post" readonly>
                    </div>

                    <div class="post-box-actions">
                        <button class="action-btn" id="photo-post-trigger">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#378fe9"><path d="M19 4H5a3 3 0 00-3 3v10a3 3 0 003 3h14a3 3 0 003-3V7a3 3 0 00-3-3zm1 13a1 1 0 01-1 1H5a1 1 0 01-1-1V7a1 1 0 011-1h14a1 1 0 011 1v10zM8 12a2 2 0 10-2-2 2 2 0 002 2z"></path></svg>
                            <span>Photo</span>
                        </button>
                        <button class="action-btn" id="video-post-trigger">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#5f9b41"><path d="M10 9v6l5-3z"></path><path d="M19 4H5a3 3 0 00-3 3v10a3 3 0 003 3h14a3 3 0 003-3V7a3 3 0 00-3-3zm-9 13V7h8v10z"></path></svg>
                            <span>Video</span>
                        </button>
                        <button class="action-btn" id="article-post-trigger">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#e16745"><path d="M21 3v2H3V3zm0 4v2H3V7zm0 4v2H3v-2zm0 4v2H3v-2z"></path></svg>
                            <span>Write article</span>
                        </button>
                    </div>
                </div>

                <div id="feed-container">
                    @foreach (var post in Model.FeedPosts)
                    {
                        var followAction = post.IsFollowing ? "unfollow" : "follow";
                        var followText = post.IsFollowing ? "Following" : "Follow";
                        var followClass = post.IsFollowing ? "following" : "";
                        <div class="card post-container" style="padding:15px; text-align:left; margin-bottom:24px;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <a asp-controller="UserProfile" asp-action="Index" asp-route-id="@post.AuthorId">
                                    <img src="@post.AuthorProfilePhoto" class="post-author-photo">
                                </a>
                                <div style="flex-grow: 1;">
                                    <a asp-controller="UserProfile" asp-action="Index" asp-route-id="@post.AuthorId">
                                        <strong data-author-name="@post.AuthorName">@post.AuthorName</strong>
                                    </a>
                                    <p style="font-size:12px; color:gray; margin:0;">@post.CreatedAtText</p>
                                </div>

                                @if (post.AuthorId != Model.UserId)
                                {
                                    <button class="follow-btn action-btn @followClass"
                                            data-user-id="@post.AuthorId"
                                            data-action="@followAction">
                                        @followText
                                    </button>
                                }
                            </div>
                            <p style="margin:10px 0;">@Html.Raw(post.ContentHtml)</p>
                            @if (post.PostType == "image" && !string.IsNullOrEmpty(post.PhotoUrl))
                            {
                                <img src="@post.PhotoUrl" style="width:100%; border-radius:8px;">
                            }
                            else if (post.PostType == "video" && !string.IsNullOrEmpty(post.PhotoUrl))
                            {
                                <video controls style="width:100%; border-radius:8px;"><source src="@post.PhotoUrl" type="video/mp4"></video>
                            }
                            <div class="post-stats" style="display:flex; gap:15px; font-size:12px; color:gray; margin:10px 0; padding-bottom:5px; border-bottom:1px solid #e0e0e0;">
                                <span id="likes-count-@post.PostId">@post.LikesCount Likes</span>
                                <span id="comments-count-@post.PostId">@post.CommentsCount Comments</span>
                                <span id="shares-count-@post.PostId">@post.SharesCount Shares</span>
                            </div>
                            <div class="post-actions" style="display:flex; justify-content:space-around; padding:5px 0; border-bottom:1px solid #e0e0e0;">
                                <button class="action-btn like-btn" data-post-id="@post.PostId"><i class="fas fa-thumbs-up"></i> Like</button>
                                <button class="action-btn comment-btn" data-post-id="@post.PostId"><i class="fas fa-comment"></i> Comment</button>
                                <button class="action-btn share-btn" data-post-id="@post.PostId"><i class="fas fa-share"></i> Share</button>
                                <button class="action-btn send-btn" data-post-id="@post.PostId"><i class="fas fa-paper-plane"></i> Send</button>
                            </div>
                            <div class="comment-section" id="comment-section-@post.PostId" style="display:none; margin-top:10px;">
                                <form action="/Posts/Action" method="POST" style="display:flex; gap:10px; margin-top:10px;">
                                    <input type="hidden" name="post_id" value="@post.PostId">
                                    <input type="hidden" name="action" value="comment">
                                    <input type="text" name="content" placeholder="Write a comment..." style="flex-grow:1; border:1px solid #ccc; border-radius:20px; padding: 8px 12px;">
                                    <button type="submit" style="background:#0a66c2; color:white; border:none; padding:8px 16px; border-radius:20px; cursor:pointer;">Post</button>
                                </form>
                                <div class="comments-list" style="margin-top:15px;">
                                    @foreach (var comment in post.Comments)
                                    {
                                        <div class="comment" style="display:flex; gap:10px; margin-top:10px;"><img src="@comment.CommenterPhoto" style="width:30px; height:30px; border-radius:50%;"><div style="background:#f3f2ef; padding:8px 12px; border-radius:15px; width:100%;"><strong>@comment.CommenterName</strong><p style="margin:2px 0 0 0; word-wrap:break-word;">@Html.Raw(comment.Content)</p></div></div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </section>

            <aside class="right-sidebar">
                <div class="card upcoming-events-card">
                    <h3>Upcoming Events</h3>
                    <ul style="padding: 0; margin: 0;">
                        @if (Model.UpcomingEvents.Count > 0)
                        {
                            @foreach (var ev in Model.UpcomingEvents)
                            {
                                <li class="event-item">
                                    <a asp-controller="Event" asp-action="Index" asp-route-view="schedule">
                                        <strong>@ev.Title</strong>
                                        <span>@ev.StartTimeText</span>
                                    </a>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="event-item"><span>No upcoming events.</span></li>
                        }
                    </ul>
                    <a asp-controller="Event" asp-action="Index" asp-route-view="schedule" class="view-all-link">View All</a>
                </div>

                <div class="card upcoming-events-card" style="margin-top:16px;">
                    <h3>Announcements</h3>
                    <div style="padding: 0 16px 16px 16px;">
                        @if (Model.Announcements.Count == 0)
                        {
                            <p class="text-muted" style="padding: 12px 0; margin:0;">No announcements.</p>
                        }
                        else
                        {
                            foreach (var ann in Model.Announcements)
                            {
                                <div style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <a href="#" class="announcement-title" data-ann-id="@ann.AnnouncementId" data-ann-title="@ann.Title" data-ann-content="@ann.ContentBase64">
        @ann.Title
                                    </a>
                                    <div class="announcement-meta">@ann.CreatedAtText</div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </aside>
        </main>

        <div id="post-creator-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create a post</h3>
                    <button id="close-modal" class="close-modal-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-user-info">
                        <img src="@Model.ProfilePhoto" alt="Profile">
                        <strong>@Model.UserName</strong>
                    </div>
                    <form id="create-post-form">
                        <textarea name="content" placeholder="What do you want to talk about?"></textarea>
                        <div id="media-preview-container" class="hidden"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <div class="modal-actions-left">
                        <label class="modal-action-icon" id="modal-photo-trigger">
                            <i class="fas fa-image"></i>
                            <span>Photo</span>
                        </label>
                        <label class="modal-action-icon" id="modal-video-trigger">
                            <i class="fas fa-video"></i>
                            <span>Video</span>
                        </label>
                        <input id="media-input" type="file" name="media" form="create-post-form" hidden>
                    </div>
                    <button type="submit" form="create-post-form" class="post-submit-btn">Post</button>
                </div>
            </div>
        </div>

        <div id="send-post-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h id="send-modal-title">Send post as a message</h3>
                        <button id="close-send-modal" class="close-modal-btn">&times;</button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <div class="send-modal-search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="send-modal-search" placeholder="Type a name...">
                    </div>
                    <div id="send-modal-user-list" class="send-modal-user-list">
                    </div>

                    <form id="send-post-form" style="border-top: 1px solid var(--border-color);">
                        <textarea name="message" placeholder="Add a message (optional)"></textarea>
                    </form>
                </div>
                <div class="modal-footer" style="justify-content: flex-end;">
                    <button type="submit" form="send-post-form" class="post-submit-btn" id="send-modal-submit-btn">Send</button>
                </div>
            </div>
        </div>

        <div id="announcement-modal" class="modal-overlay hidden" aria-hidden="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="announcement-modal-title">Announcement</h3>
                    <button id="close-announcement-modal" class="close-modal-btn">&times;</button>
                </div>
                <div class="modal-body" id="announcement-modal-body" style="max-height:60vh; overflow:auto;">
                    <div class="modal-user-info">
                        <strong id="announcement-modal-admin">Admin</strong>
                    </div>
                    <div id="announcement-modal-content" style="white-space:pre-wrap; font-size:14px; color:var(--text-color);"></div>
                    <div style="margin-top:12px; font-size:12px; color:var(--text-muted);" id="announcement-modal-meta"></div>
                </div>
                <div class="modal-footer">
                    <div></div>
                    <button id="announcement-modal-close" class="post-submit-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- MOBILE NAV: ADDED JOBS ICON HERE AS WELL -->
        <nav class="mobile-nav">
    <!-- Home -->
    <a asp-controller="Dashboard" asp-action="UserDashboard" class="mobile-nav-item @(Model.CurrentPage == "UserDashboard" ? "active" : "")">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>Home</span>
    </a>

    <!-- Network -->
    <a asp-controller="MyNetwork" asp-action="Index" class="mobile-nav-item @(Model.CurrentPage == "MyNetwork" ? "active" : "")">
        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        <span>Network</span>
    </a>

    <!-- Events -->
    <a asp-controller="Event" asp-action="Index" asp-route-view="schedule" class="mobile-nav-item @(Model.CurrentPage == "Event" ? "active" : "")">
        <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>
        <span>Events</span>
    </a>

    <!-- Messaging -->
    <a asp-controller="Messages" asp-action="Index" class="mobile-nav-item @(Model.CurrentPage == "Message" ? "active" : "")">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
        <span>Messages</span>
    </a>

    <!-- Notifications -->
    <div class="mobile-nav-item @(Model.CurrentPage == "Notifications" ? "active" : "")" id="mobile-notification-trigger">
        <div class="mobile-nav-icon-wrapper">
            <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
            <span id="mobile-notification-badge" class="mobile-notification-badge hidden"></span>
        </div>
        <span>Notify</span>
    </div>
</nav>
        <script>
            let toastTimer;
            function showToast(message, isError = false) {
                const toast = document.getElementById('toast-notification');
                if (!toast)
                    return;
                clearTimeout(toastTimer);
                toast.textContent = message;
                toast.className = 'toast';
                if (isError) {
                    toast.classList.add('error');
                }
                toast.classList.add('show');
                toastTimer = setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // Define escapeHTML globally
            function escapeHTML(str) {
                const p = document.createElement("p");
                p.textContent = (str === null || str === undefined) ? "" : str.toString();
                return p.innerHTML;
            }

            function createPostHTML(post) {
                const author = escapeHTML(`${post.first_name} ${post.last_name}`);
                const profileImg = post.profile_photo_url ? escapeHTML(post.profile_photo_url) : 'https://placehold.co/50x50';
                const content = escapeHTML(post.content).replace(/\n/g, '<br>');
                let mediaHTML = '';
                if (post.post_type === 'image' && post.photo_url) {
                    mediaHTML = `<img src="${escapeHTML(post.photo_url)}" style="width:100%; border-radius:8px;">`;
                } else if (post.post_type === 'video' && post.photo_url) {
                    mediaHTML = `<video controls style="width:100%; border-radius:8px;"><source src="${escapeHTML(post.photo_url)}" type="video/mp4"></video>`;
                }
                const postAuthorId = post.user_id;

                return `
                <div class="card post-container" style="padding:15px; text-align:left; margin-bottom:24px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <a href="/Dashboard/UserProfile?id=${postAuthorId}">
                            <img src="${profileImg}" class="post-author-photo">
                        </a>
                        <div style="flex-grow: 1;">
                            <a href="/Dashboard/UserProfile?id=${postAuthorId}">
                                <strong data-author-name="${author}">${author}</strong>
                            </a>
                            <p style="font-size:12px; color:gray; margin:0;">${post.created_at}</p>
                        </div>
                        </div>
                    <p style="margin:10px 0;">${content}</p>
                    ${mediaHTML}
                    <div class="post-stats" style="display:flex; gap:15px; font-size:12px; color:gray; margin:10px 0; padding-bottom:5px; border-bottom:1px solid #e0e0e0;">
                        <span id="likes-count-${post.post_id}">0 Likes</span>
                        <span id="comments-count-${post.post_id}">0 Comments</span>
                        <span id="shares-count-${post.post_id}">0 Shares</span>
                    </div>
                    <div class="post-actions" style="display:flex; justify-content:space-around; padding:5px 0; border-bottom:1px solid #e0e0e0;">
                        <button class="action-btn like-btn" data-post-id="${post.post_id}"><i class="fas fa-thumbs-up"></i> Like</button>
                        <button class="action-btn comment-btn" data-post-id="${post.post_id}"><i class="fas fa-comment"></i> Comment</button>
                        <button class="action-btn share-btn" data-post-id="${post.post_id}"><i class="fas fa-share"></i> Share</button>
                        <button class="action-btn send-btn" data-post-id="${post.post_id}"><i class="fas fa-paper-plane"></i> Send</button>
                    </div>
                    <div class="comment-section" id="comment-section-${post.post_id}" style="display:none; margin-top:10px;">
                        <form action="/Posts/Action" method="POST" style="display:flex; gap:10px; margin-top:10px;">
                            <input type="hidden" name="post_id" value="${post.post_id}"><input type="hidden" name="action" value="comment">
                            <input type="text" name="content" placeholder="Write a comment..." style="flex-grow:1; border:1px solid #ccc; border-radius:20px; padding: 8px 12px;">
                            <button type="submit" style="background:#0a66c2; color:white; border:none; padding:8px 16px; border-radius:20px; cursor:pointer;">Post</button>
                        </form>
                        <div class="comments-list" style="margin-top:15px;"></div>
                    </div>
                </div>`;
            }

            document.addEventListener('DOMContentLoaded', function () {

                // --- Navbar Search ---
                const searchInput = document.getElementById('search-input');
                const resultsContainer = document.getElementById('search-results-container');
                const mobileSearchInput = document.getElementById('mobile-search-input');
                const mobileResultsContainer = document.getElementById('mobile-search-results-container');
                let debounceTimer;

                // --- *** FULLY UPDATED handleSearch FUNCTION *** ---
                // This version fixes the "Unexpected end of JSON input" error
                // by reading the response as text first, which prevents a crash on empty error responses.
                function handleSearch(query, resultsEl) {
                    if (query.length < 1) {
                        resultsEl.innerHTML = '';
                        resultsEl.classList.add('hidden');
                        return;
                    }

                    fetch(`/Users/Search?q=${encodeURIComponent(query)}`)
                            .then(response => {
                                // First, get the raw text of the response
                                return response.text().then(text => {
                                    return {text: text, ok: response.ok, status: response.status};
                                });
                            })
                            .then(response => {
                                if (!response.ok) {
                                    // It's an error. Try to parse the text as JSON
                                    try {
                                        const errorData = JSON.parse(response.text);
                                        // We got a JSON error from our PHP script
                                        throw new Error(errorData.error || `Server error: ${response.status}`);
                                    } catch (e) {
                                        // The error was not JSON. It was probably an empty body or HTML.
                                        // This is what causes "Unexpected end of JSON input"
                                        if (response.text.trim() === '') {
                                            throw new Error('Search failed: Server returned an empty error response.');
                                        }
                                        // It was HTML or some other junk
                                        throw new Error(`Search failed: Server returned an invalid response (Status: ${response.status}).`);
                                    }
                                }

                                // --- Response was OK ---
                                // Try to parse the successful response as JSON
                                try {
                                    const users = JSON.parse(response.text);
                                    resultsEl.innerHTML = '';
                                    if (users.length > 0) {
                                        users.forEach(user => {
                                            const item = document.createElement('a');
                                            item.href = `/Dashboard/UserProfile?id=${user.user_id}`;
                                            item.classList.add('search-result-item');
                                            // Use the photo URL from the server, or the placeholder
                                            const photoUrl = user.profile_photo_url ? escapeHTML(user.profile_photo_url) : 'https://placehold.co/40x40/6366f1/white?text=' + escapeHTML(user.full_name.substring(0, 1).toUpperCase());
                                            const headline = user.headline ? escapeHTML(user.headline) : 'User';
                                            const fullName = escapeHTML(user.full_name);

                                            item.innerHTML = `
                                            <img src="${photoUrl}" alt="${fullName}">
                                            <div><strong>${fullName}</strong><br><span>${headline}</span></div>`;
                                            resultsEl.appendChild(item);
                                        });
                                    } else {
                                        resultsEl.innerHTML = '<div style="padding: 12px; font-size: 14px; color: var(--text-muted);">No results found.</div>';
                                    }
                                    resultsEl.classList.remove('hidden');

                                } catch (e) {
                                    // This should almost never happen if response.ok is true
                                    throw new Error('Failed to read search results from server.');
                                }
                            })
                            .catch(error => {
                                // This will catch network errors OR any error we threw
                                console.error('Search error:', error);
                                // Display the *specific* error message!
                                resultsEl.innerHTML = `<div style="padding: 12px; color: red;">${escapeHTML(error.message)}</div>`;
                                resultsEl.classList.remove('hidden');
                            });
                }

                // Attach to desktop search
                if (searchInput) {
                    searchInput.addEventListener('input', function () {
                        clearTimeout(debounceTimer);
                        const query = this.value;
                        debounceTimer = setTimeout(() => handleSearch(query, resultsContainer), 300);
                    });
                }

                // Attach to mobile search
                if (mobileSearchInput) {
                    mobileSearchInput.addEventListener('input', function () {
                        clearTimeout(debounceTimer);
                        const query = this.value;
                        debounceTimer = setTimeout(() => handleSearch(query, mobileResultsContainer), 300);
                    });
                }
                // --- *** END OF UPDATED JAVASCRIPT *** ---

                // --- Page Modals & Actions ---
                const feedContainer = document.getElementById('feed-container');
                const startPostTrigger = document.getElementById('start-post');
                const postCreatorModal = document.getElementById('post-creator-modal');
                const closeModalBtn = document.getElementById('close-modal');
                const mediaInput = document.getElementById('media-input');
                const mediaPreviewContainer = document.getElementById('media-preview-container');
                const createPostForm = document.getElementById('create-post-form');
                const sendPostModal = document.getElementById('send-post-modal');
                const closeSendModalBtn = document.getElementById('close-send-modal');
                const sendModalUserList = document.getElementById('send-modal-user-list');
                const sendModalSearch = document.getElementById('send-modal-search');
                const sendPostForm = document.getElementById('send-post-form');
                const sendModalSubmitBtn = document.getElementById('send-modal-submit-btn');
                const sendModalTitle = document.getElementById('send-modal-title');
                let modalMessageUsers = [];
                const photoPostTrigger = document.getElementById('photo-post-trigger');
                const videoPostTrigger = document.getElementById('video-post-trigger');
                const articlePostTrigger = document.getElementById('article-post-trigger');
                const modalPhotoTrigger = document.getElementById('modal-photo-trigger');
                const modalVideoTrigger = document.getElementById('modal-video-trigger');

                const showModal = () => postCreatorModal.classList.remove('hidden');
                const hideModal = () => {
                    postCreatorModal.classList.add('hidden');
                    createPostForm.reset();
                    mediaPreviewContainer.innerHTML = '';
                    mediaPreviewContainer.classList.add('hidden');
                    mediaInput.accept = "image/*,video/*";
                };

                if (startPostTrigger)
                    startPostTrigger.addEventListener('click', showModal);
                if (closeModalBtn)
                    closeModalBtn.addEventListener('click', hideModal);
                if (photoPostTrigger)
                    photoPostTrigger.addEventListener('click', () => {
                        showModal();
                        mediaInput.accept = "image/*";
                        mediaInput.click();
                    });
                if (videoPostTrigger)
                    videoPostTrigger.addEventListener('click', () => {
                        showModal();
                        mediaInput.accept = "video/*";
                        mediaInput.click();
                    });
                if (articlePostTrigger)
                    articlePostTrigger.addEventListener('click', showModal);
                if (modalPhotoTrigger)
                    modalPhotoTrigger.addEventListener('click', () => {
                        mediaInput.accept = 'image/*';
                        mediaInput.click();
                    });
                if (modalVideoTrigger)
                    modalVideoTrigger.addEventListener('click', () => {
                        mediaInput.accept = 'video/*';
                        mediaInput.click();
                    });
                if (postCreatorModal)
                    postCreatorModal.addEventListener('click', (e) => {
                        if (e.target === postCreatorModal)
                            hideModal();
                    });
                if (mediaInput)
                    mediaInput.addEventListener('change', function () {
                        const file = this.files[0];
                        if (file) {
                            const objectURL = URL.createObjectURL(file);
                            mediaPreviewContainer.innerHTML = '';
                            if (file.type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src = objectURL;
                                mediaPreviewContainer.appendChild(img);
                            } else if (file.type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src = objectURL;
                                video.controls = true;
                                mediaPreviewContainer.appendChild(video);
                            }
                            mediaPreviewContainer.classList.remove('hidden');
                        }
                    });
                if (createPostForm)
                    createPostForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        const postButton = document.querySelector('.post-submit-btn');
                        postButton.disabled = true;
                        postButton.textContent = 'Posting...';

                        fetch('UploadPost/UploadPost', {method: 'POST', body: formData})
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        const newPostHTML = createPostHTML(data.post);
                                        feedContainer.insertAdjacentHTML('afterbegin', newPostHTML);
                                        hideModal();
                                        showToast('Post created successfully!');
                                    } else {
                                        showToast(data.message || 'Could not create post.', true);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showToast('An error occurred while posting.', true);
                                })
                                .finally(() => {
                                    postButton.disabled = false;
                                    postButton.textContent = 'Post';
                                });
                    });

                // --- Send Modal Functions ---
                function renderMessageUserList(users) {
                    sendModalUserList.innerHTML = '';
                    if (users.length === 0) {
                        sendModalUserList.innerHTML = '<p style="padding: 16px; text-align: center; color: var(--text-muted);">No users found.</p>';
                        return;
                    }
                    users.forEach(user => {
                        const itemHTML = `
                        <label class="send-modal-user-item" for="send-user-${user.user_id}">
                            <img src="${escapeHTML(user.profile_photo_url)}" alt="${escapeHTML(user.first_name)}">
                            <div>
                                <strong>${escapeHTML(user.first_name + ' ' + user.last_name)}</strong>
                                <span>${escapeHTML(user.headline)}</span>
                            </div>
                            <input type="checkbox" name="receiver_ids[]" id="send-user-${user.user_id}" value="${user.user_id}">
                        </label>`;
                        sendModalUserList.insertAdjacentHTML('beforeend', itemHTML);
                    });
                }
                function loadMessageUsersForSendModal() {
                    sendModalUserList.innerHTML = '<p style="padding: 16px; text-align: center;">Loading users...</p>';
                    fetch('/Messages/ShareRecipients')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    modalMessageUsers = data.users;
                                    renderMessageUserList(modalMessageUsers);
                                } else {
                                    sendModalUserList.innerHTML = `<p style="padding: 16px; text-align: center; color: red;">${data.message}</p>`;
                                }
                            })
                            .catch(err => {
                                sendModalUserList.innerHTML = '<p style="padding: 16px; text-align: center; color: red;">Failed to load users.</p>';
                            });
                }
                if (sendModalSearch)
                    sendModalSearch.addEventListener('input', function () {
                        const query = this.value.toLowerCase();
                        const filteredUsers = modalMessageUsers.filter(user => {
                            const fullName = (user.first_name + ' ' + user.last_name).toLowerCase();
                            return fullName.includes(query);
                        });
                        renderMessageUserList(filteredUsers);
                    });
                const hideSendModal = () => {
                    sendPostModal.classList.add('hidden');
                    sendPostForm.reset();
                    sendModalSearch.value = '';
                    sendModalUserList.innerHTML = '';
                    modalMessageUsers = [];
                    sendModalTitle.textContent = 'Send post as a message';
                };
                if (closeSendModalBtn)
                    closeSendModalBtn.addEventListener('click', hideSendModal);
                if (sendPostModal)
                    sendPostModal.addEventListener('click', (e) => {
                        if (e.target === sendPostModal)
                            hideSendModal();
                    });
                if (sendPostForm)
                    sendPostForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const checkedBoxes = sendModalUserList.querySelectorAll('input[type="checkbox"]:checked');
                        const receiverIds = Array.from(checkedBoxes).map(cb => cb.value);
                        if (receiverIds.length === 0) {
                            showToast('Please select at least one person.', true);
                            return;
                        }
                        const formData = new FormData(this);
                        formData.append('receiver_ids', JSON.stringify(receiverIds));
                        sendModalSubmitBtn.disabled = true;
                        sendModalSubmitBtn.textContent = 'Sending...';

                        fetch(`/Posts/Share/${this.dataset.postId}`, {method: 'POST', body: formData})
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        hideSendModal();
                                        showToast(data.message || 'Post sent!');
                                    } else {
                                        showToast(data.message || 'Could not send post.', true);
                                    }
                                })
                                .catch(err => showToast('An error occurred.', true))
                                .finally(() => {
                                    sendModalSubmitBtn.disabled = false;
                                    sendModalSubmitBtn.textContent = 'Send';
                                });
                    });

                // --- Feed Actions (Like, Comment, Share, Send, Follow) ---
                if (feedContainer) {
                    feedContainer.addEventListener('click', async function (e) {
                        const targetButton = e.target.closest('.action-btn');
                        if (!targetButton)
                            return;

                        if (targetButton.classList.contains('follow-btn')) {
                            e.preventDefault();
                            const button = targetButton;
                            const targetUserId = button.dataset.userId;
                            const action = button.dataset.action;
                            const formData = new FormData();
                            formData.append('target_user_id', targetUserId);
                            formData.append('action', action);
                            fetch('FollowAction', {method: 'POST', body: formData})
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            const allFollowButtons = document.querySelectorAll(`.follow-btn[data-user-id="${targetUserId}"]`);
                                            if (action === 'follow') {
                                                allFollowButtons.forEach(btn => {
                                                    btn.textContent = 'Following';
                                                    btn.dataset.action = 'unfollow';
                                                    btn.classList.add('following');
                                                });
                                            } else {
                                                allFollowButtons.forEach(btn => {
                                                    btn.textContent = 'Follow';
                                                    btn.dataset.action = 'follow';
                                                    btn.classList.remove('following');
                                                });
                                            }
                                        } else {
                                            showToast(data.message || 'Action failed.', true);
                                        }
                                    })
                                    .catch(err => {
                                        console.error('Follow error:', err);
                                        showToast('A network error occurred.', true);
                                    });
                            return;
                        }

                        const postId = targetButton.dataset.postId;
                        if (targetButton.classList.contains('send-btn') || targetButton.classList.contains('share-btn')) {
                            const postContainer = targetButton.closest('.post-container');
                            const authorNameElement = postContainer.querySelector('div > strong[data-author-name]');
                            if (authorNameElement) {
                                sendModalTitle.textContent = `Send ${escapeHTML(authorNameElement.dataset.authorName)}'s Post`;
                            }
                            sendPostForm.dataset.postId = postId;
                            sendPostModal.classList.remove('hidden');
                            loadMessageUsersForSendModal();
                            return;
                        }

                        if (targetButton.classList.contains('comment-btn')) {
                            const commentSection = document.getElementById(`comment-section-${postId}`);
                            if (commentSection)
                                commentSection.style.display = commentSection.style.display === 'none' ? 'block' : 'none';
                            return;
                        }

                        let action = '';
                        if (targetButton.classList.contains('like-btn'))
                            action = 'like';
                        if (!action)
                            return;

                        const formData = new FormData();
                        formData.append('post_id', postId);
                        formData.append('action', action);
                        fetch('/Posts/Action', {method: 'POST', body: formData})
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success && data.counts) {
                                        document.getElementById(`likes-count-${postId}`).textContent = `${data.counts.likes_count} Likes`;
                                        document.getElementById(`comments-count-${postId}`).textContent = `${data.counts.comments_count} Comments`;
                                        document.getElementById(`shares-count-${postId}`).textContent = `${data.counts.shares_count} Shares`;
                                        if (action === 'like')
                                            targetButton.style.color = data.liked ? '#0a66c2' : '#666';
                                        if (action === 'share')
                                            targetButton.style.color = '#0a66c2';
                                    } else {
                                        showToast(data.message || 'An error occurred.', true);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showToast('A network error occurred.', true);
                                });
                    });
                }

                // --- Announcement modal handling ---
                const announcementModal = document.getElementById('announcement-modal');
                const announcementModalTitle = document.getElementById('announcement-modal-title');
                const announcementModalContent = document.getElementById('announcement-modal-content');
                const announcementModalMeta = document.getElementById('announcement-modal-meta');
                const announcementModalAdmin = document.getElementById('announcement-modal-admin');
                const closeAnnouncementModal = document.getElementById('close-announcement-modal');
                const announcementModalClose = document.getElementById('announcement-modal-close');

                function openAnnouncementModal(title, b64content, created) {
                    let decoded = '';
                    try {
                        // atob returns binary string; decodeURIComponent handles UTF-8 characters
                        decoded = decodeURIComponent(escape(atob(b64content)));
                    } catch (err) {
                        // fallback if above fails (non-utf8)
                        try {
                            decoded = atob(b64content);
                        } catch (e) {
                            decoded = '';
                        }
                    }
                    announcementModalTitle.textContent = title;
                    announcementModalContent.innerHTML = escapeHTML(decoded).replace(/\n/g, '<br>');
                    announcementModalMeta.textContent = 'Posted: ' + created;
                    announcementModalAdmin.textContent = 'Admin';
                    announcementModal.classList.remove('hidden');
                    announcementModal.setAttribute('aria-hidden', 'false');
                }

                function closeAnnouncement() {
                    announcementModal.classList.add('hidden');
                    announcementModal.setAttribute('aria-hidden', 'true');
                }

                document.addEventListener('click', function (ev) {
                    const ann = ev.target.closest('.announcement-title');
                    if (!ann)
                        return;
                    ev.preventDefault();
                    const title = ann.getAttribute('data-ann-title') || 'Announcement';
                    const b64 = ann.getAttribute('data-ann-content') || '';
                    const createdMeta = ann.parentElement.querySelector('.announcement-meta') ? ann.parentElement.querySelector('.announcement-meta').textContent : '';
                    openAnnouncementModal(title, b64, createdMeta);
                });

                if (closeAnnouncementModal)
                    closeAnnouncementModal.addEventListener('click', closeAnnouncement);
                if (announcementModalClose)
                    announcementModalClose.addEventListener('click', closeAnnouncement);
                if (announcementModal)
                    announcementModal.addEventListener('click', function (e) {
                        if (e.target === announcementModal)
                            closeAnnouncement();
                    });

                // --- Notification & "Me" Menu Script ---
                const meMenuTrigger = document.getElementById('me-menu-trigger');
                const meMenu = document.getElementById('me-menu');
                const notificationTrigger = document.getElementById('notification-trigger');
                const notificationDropdown = document.getElementById('notification-dropdown');
                const notificationBadge = document.getElementById('notification-badge');
                const notificationList = document.getElementById('notification-list');

                // --- NEW: Mobile Nav Elements ---
                const mobileNotificationTrigger = document.getElementById('mobile-notification-trigger');
                const mobileNotificationBadge = document.getElementById('mobile-notification-badge');

                function getNotificationText(notification) {
                    const sender_name = `<strong>${escapeHTML(notification.first_name + ' ' + notification.last_name)}</strong>`;
                    switch (notification.type) {
                        case 'like':
                            return `${sender_name} liked your post.`;
                        case 'comment':
                            return `${sender_name} commented on your post.`;
                        case 'follow':
                            return `${sender_name} started following you.`;
                        case 'connect_request':
                            return `${sender_name} sent you a connection request.`;
                        case 'connect_accept':
                            return `${sender_name} accepted your connection request.`;
                        case 'new_post':
                            return `${sender_name} published a new post.`;
                        case 'message':
                            return `${sender_name} sent you a new message.`;
                        default:
                            return 'New notification.';
                    }
                }
                function getNotificationLink(notification) {
                    const sender_id = notification.sender_id;
                    const entity_id = notification.entity_id;
                    switch (notification.type) {
                        case 'like':
                        case 'comment':
                        case 'new_post':
                            return `/Dashboard/ViewPost?id=${entity_id}`;
                        case 'follow':
                        case 'connect_accept':
                            return `/Dashboard/UserProfile?id=${sender_id}`;
                        case 'connect_request':
                            return '/Dashboard/MyNetwork';
                        case 'message':
                            return `/Messages/Conversation/${sender_id}`;
                        default:
                            return '#';
                    }
                }
                function fetchNotificationCount() {
                    fetch('/Notifications/Count')
                            .then(response => response.json())
                            .then(data => {
                                if (data.unread_count > 0) {
                                    // Update *both* badges
                                    notificationBadge.textContent = data.unread_count;
                                    notificationBadge.classList.remove('hidden');
                                    if (mobileNotificationBadge) {
                                        mobileNotificationBadge.textContent = data.unread_count;
                                        mobileNotificationBadge.classList.remove('hidden');
                                    }
                                } else {
                                    // Hide *both* badges
                                    notificationBadge.classList.add('hidden');
                                    if (mobileNotificationBadge) {
                                        mobileNotificationBadge.classList.add('hidden');
                                    }
                                }
                            })
                            .catch(e => console.error("Error fetching notification count:", e));
                }
                function fetchNotificationList() {
                    notificationList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading...</div>';
                    fetch('/Notifications/List')
                            .then(response => response.json())
                            .then(data => {
                                notificationList.innerHTML = '';
                                if (data.notifications && data.notifications.length > 0) {
                                    data.notifications.forEach(n => {
                                        const text = getNotificationText(n);
                                        const link = getNotificationLink(n);
                                        const isUnread = n.is_read == 0 ? 'unread' : '';
                                        const time_ago = new Date(n.created_at);
                                        const now = new Date();
                                        const diff = (now.getTime() - time_ago.getTime()) / 1000;
                                        let time_text = '';
                                        if (diff < 60)
                                            time_text = 'Just now';
                                        else if (diff < 3600)
                                            time_text = `${Math.floor(diff / 60)}m ago`;
                                        else if (diff < 86400)
                                            time_text = `${Math.floor(diff / 3600)}h ago`;
                                        else if (diff < 2592000)
                                            time_text = `${Math.floor(diff / 86400)}d ago`;
                                        else if (diff < 31536000)
                                            time_text = `${Math.floor(diff / 2592000)}mo ago`;
                                        else
                                            time_text = `${Math.floor(diff / 31536000)}y ago`;

                                        const item = document.createElement('a');
                                        item.href = link;
                                        item.innerHTML = `
                                        <div class="notification-item ${isUnread}">
                                            <img src="${escapeHTML(n.profile_photo_url)}" alt="Profile">
                                            <div>
                                                <p>${text}</p>
                                                <span>${time_text}</span>
                                            </div>
                                        </div>`;
                                        notificationList.appendChild(item);
                                    });
                                } else {
                                    notificationList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No new notifications.</div>';
                                }
                                // Mark read and hide *both* badges
                                fetch('/Notifications/MarkRead', {method: 'POST'});
                                notificationBadge.classList.add('hidden');
                                if (mobileNotificationBadge) {
                                    mobileNotificationBadge.classList.add('hidden');
                                }
                            })
                            .catch(e => console.error("Error fetching notification list:", e));
                }

                const openNotificationDropdown = (event) => {
                    event.stopPropagation();
                    const isHidden = notificationDropdown.classList.toggle('hidden');
                    if (meMenu)
                        meMenu.classList.add('hidden');
                    if (!isHidden) {
                        fetchNotificationList();
                    }
                };

                if (notificationTrigger) {
                    // Use the new function for the top bar trigger
                    notificationTrigger.addEventListener('click', openNotificationDropdown);
                }

                // --- NEW: Add listener for mobile notification trigger ---
                if (mobileNotificationTrigger) {
                    // Use the *same* function for the mobile bar trigger
                    mobileNotificationTrigger.addEventListener('click', openNotificationDropdown);
                }

                if (meMenuTrigger) {
                    meMenuTrigger.addEventListener('click', function (event) {
                        event.stopPropagation();
                        meMenu.classList.toggle('hidden');
                        if (notificationDropdown)
                            notificationDropdown.classList.add('hidden');
                    });
                }

                // Global click listener to close all dropdowns
                if (!document.body.dataset.globalClickListenerAdded) {
                    document.addEventListener('click', function (event) {
                        // Get all search elements
                        const resultsContainer = document.getElementById('search-results-container');
                        const searchInput = document.getElementById('search-input');
                        const mobileResultsContainer = document.getElementById('mobile-search-results-container');
                        const mobileSearchInput = document.getElementById('mobile-search-input');

                        // Close "Me" menu
                        if (meMenu && !meMenu.classList.contains('hidden') && meMenuTrigger && !meMenuTrigger.contains(event.target) && !meMenu.contains(event.target)) {
                            meMenu.classList.add('hidden');
                        }

                        // Close Notification dropdown
                        if (notificationDropdown && !notificationDropdown.classList.contains('hidden') && notificationTrigger && !notificationTrigger.contains(event.target) && !notificationDropdown.contains(event.target) && mobileNotificationTrigger && !mobileNotificationTrigger.contains(event.target)) {
                            notificationDropdown.classList.add('hidden');
                        }

                        // Close Desktop search results
                        if (resultsContainer && !resultsContainer.classList.contains('hidden') && searchInput && !searchInput.contains(event.target) && !resultsContainer.contains(event.target)) {
                            resultsContainer.classList.add('hidden');
                        }

                        // NEW: Close Mobile search results
                        if (mobileResultsContainer && !mobileResultsContainer.classList.contains('hidden') && mobileSearchInput && !mobileSearchInput.contains(event.target) && !mobileResultsContainer.contains(event.target)) {
                            mobileResultsContainer.classList.add('hidden');
                        }
                    });
                    document.body.dataset.globalClickListenerAdded = 'true';
                }

                // Initial fetch and polling
                fetchNotificationCount();
                setInterval(fetchNotificationCount, 30000);

            });
        </script>

    </body>
</html>









